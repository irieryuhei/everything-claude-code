---
description: 要件を再確認し、リスクを評価し、ステップバイステップの実装計画を作成します。コードに触れる前にユーザーの確認を待ちます。
---

# Planコマンド

このコマンドは**planner**エージェントを呼び出して、コードを書く前に包括的な実装計画を作成します。

## このコマンドの機能

1. **要件の再確認** - 何を構築する必要があるかを明確化
2. **リスクの特定** - 潜在的な問題やブロッカーを表面化
3. **ステップ計画の作成** - 実装をフェーズに分解
4. **確認を待機** - 進行前にユーザーの承認を必ず受ける

## 使用するタイミング

以下の場合に `/plan` を使用：
- 新機能の開始時
- 重要なアーキテクチャ変更時
- 複雑なリファクタリングに取り組む時
- 複数のファイル/コンポーネントが影響を受ける時
- 要件が不明確または曖昧な時

## 動作方法

plannerエージェントは以下を実行します：

1. **リクエストを分析**し、要件を明確な言葉で再確認
2. **フェーズに分解**（具体的でアクション可能なステップ）
3. **依存関係を特定**（コンポーネント間の関係）
4. **リスクを評価**（潜在的なブロッカー）
5. **複雑さを見積もり**（高/中/低）
6. **計画を提示**し、明示的な確認を待機

## 使用例

```
ユーザー: /plan マーケットが決済されたときにリアルタイム通知を追加する必要があります

エージェント (planner):
# 実装計画: リアルタイムマーケット決済通知

## 要件の再確認
- ユーザーがウォッチしているマーケットが決済されたときに通知を送信
- 複数の通知チャネルをサポート（アプリ内、メール、Webhook）
- 通知が確実に配信されることを保証
- マーケットの結果とユーザーのポジション結果を含める

## 実装フェーズ

### フェーズ1: データベーススキーマ
- 通知テーブルを追加（カラム: id, user_id, market_id, type, status, created_at）
- チャネル設定用のuser_notification_preferencesテーブルを追加
- パフォーマンスのためにuser_idとmarket_idにインデックスを作成

### フェーズ2: 通知サービス
- lib/notifications.tsに通知サービスを作成
- BullMQ/Redisを使用した通知キューを実装
- 失敗した配信のリトライロジックを追加
- 通知テンプレートを作成

### フェーズ3: 統合ポイント
- マーケット決済ロジックにフック（ステータスが「resolved」に変更されたとき）
- マーケットにポジションを持つすべてのユーザーをクエリ
- 各ユーザーの通知をエンキュー

### フェーズ4: フロントエンドコンポーネント
- ヘッダーにNotificationBellコンポーネントを作成
- NotificationListモーダルを追加
- Supabaseサブスクリプション経由でリアルタイム更新を実装
- 通知設定ページを追加

## 依存関係
- Redis（キュー用）
- メールサービス（SendGrid/Resend）
- Supabaseリアルタイムサブスクリプション

## リスク
- 高: メール配信可能性（SPF/DKIM必須）
- 中: マーケットあたり1000+ユーザーでのパフォーマンス
- 中: マーケットが頻繁に決済される場合の通知スパム
- 低: リアルタイムサブスクリプションのオーバーヘッド

## 見積もり複雑さ: 中
- バックエンド: 4-6時間
- フロントエンド: 3-4時間
- テスト: 2-3時間
- 合計: 9-13時間

**確認を待機中**: この計画で進めますか？（yes/no/modify）
```

## 重要な注意事項

**クリティカル**: plannerエージェントは、「yes」「proceed」などの肯定的な返答で明示的に計画を確認するまで、**コードを書きません**。

変更が必要な場合は、以下のように返答してください：
- 「modify: [変更内容]」
- 「different approach: [代替案]」
- 「フェーズ2をスキップしてフェーズ3を先に」

## 他のコマンドとの統合

計画後：
- `/tdd` を使用してテスト駆動開発で実装
- ビルドエラーが発生した場合は `/build-and-fix` を使用
- `/code-review` を使用して完成した実装をレビュー

## 関連エージェント

このコマンドは以下に配置された `planner` エージェントを呼び出します：
`~/.claude/agents/planner.md`
