# プラグインマニフェストスキーマ注意事項

このドキュメントは、Claude Code プラグインマニフェストバリデーターの**ドキュメント化されていないが強制される制約**を記載しています。

これらのルールは、実際のインストール失敗、バリデーターの動作、および動作確認済みプラグインとの比較に基づいています。
サイレントな破損と繰り返しの回帰を防ぐために存在します。

`.claude-plugin/plugin.json` を編集する場合は、まずこれを読んでください。

---

## 概要（最初にお読みください）

Claude プラグインマニフェストバリデーターは**厳格で独自の意見を持っています**。
公開スキーマリファレンスに完全にドキュメント化されていないルールを強制します。

最も一般的な失敗パターンは：

> マニフェストは妥当に見えるが、バリデーターが
> `agents: Invalid input` のような曖昧なエラーで拒否する

このドキュメントはその理由を説明します。

---

## 必須フィールド

### `version`（必須）

`version` フィールドは、一部の例で省略されていても、バリデーターによって必須とされています。

欠落している場合、マーケットプレイスインストールまたは CLI バリデーション中にインストールが失敗する可能性があります。

例：

```json
{
  "version": "1.1.0"
}
```

---

## フィールド形式ルール

以下のフィールドは**常に配列でなければなりません**：

* `agents`
* `commands`
* `skills`
* `hooks`（存在する場合）

エントリが1つだけであっても、**文字列は受け入れられません**。

### 無効

```json
{
  "agents": "./agents"
}
```

### 有効

```json
{
  "agents": ["./agents/planner.md"]
}
```

これはすべてのコンポーネントパスフィールドに一貫して適用されます。

---

## パス解決ルール（重要）

### agents は明示的なファイルパスを使用する必要があります

バリデーターは**`agents` にディレクトリパスを受け入れません**。

以下のような記述でも失敗します：

```json
{
  "agents": ["./agents/"]
}
```

代わりに、エージェントファイルを明示的に列挙する必要があります：

```json
{
  "agents": [
    "./agents/planner.md",
    "./agents/architect.md",
    "./agents/code-reviewer.md"
  ]
}
```

これがバリデーションエラーの最も一般的な原因です。

### commands と skills

* `commands` と `skills` は**配列でラップされている場合のみ**ディレクトリパスを受け入れます
* 明示的なファイルパスが最も安全で将来性があります

---

## バリデーター動作の注意点

* `claude plugin validate` は一部のマーケットプレイスプレビューよりも厳格です
* バリデーションがローカルで通過しても、パスが曖昧な場合はインストール中に失敗する可能性があります
* エラーは多くの場合汎用的（`Invalid input`）で、根本原因を示しません
* クロスプラットフォームインストール（特に Windows）はパスの仮定に対してより厳格です

バリデーターは敵対的でリテラルであると想定してください。

---

## `hooks` フィールド：追加しないでください

> ⚠️ **重要:** `plugin.json` に `"hooks"` フィールドを追加しないでください。これは回帰テストによって強制されています。

### なぜこれが重要か

Claude Code v2.1+ は、インストールされた任意のプラグインから `hooks/hooks.json` を慣習により**自動的に読み込みます**。これを `plugin.json` でも宣言すると、以下のエラーが発生します：

```
Duplicate hooks file detected: ./hooks/hooks.json resolves to already-loaded file.
The standard hooks/hooks.json is loaded automatically, so manifest.hooks should
only reference additional hook files.
```

### 修正/取り消しの履歴

このリポジトリでは繰り返し修正/取り消しサイクルが発生しています：

| コミット | アクション | トリガー |
|--------|--------|---------|
| `22ad036` | hooks を追加 | ユーザーが「hooks が読み込まれない」と報告 |
| `a7bc5f2` | hooks を削除 | ユーザーが「duplicate hooks エラー」と報告 (#52) |
| `779085e` | hooks を追加 | ユーザーが「agents が読み込まれない」と報告 (#88) |
| `e3a1306` | hooks を削除 | ユーザーが「duplicate hooks エラー」と報告 (#103) |

**根本原因:** Claude Code CLI がバージョン間で動作を変更しました：
- v2.1 以前：明示的な `hooks` 宣言が必要
- v2.1+：慣習により自動読み込み、重複でエラー

### 現在のルール（テストによって強制）

`tests/hooks/hooks.test.js` のテスト `plugin.json does NOT have explicit hooks declaration` が再導入を防止しています。

**追加のフックファイルを追加する場合**（`hooks/hooks.json` ではない）、それらは宣言できます。ただし、標準の `hooks/hooks.json` は宣言してはいけません。

---

## 既知のアンチパターン

これらは正しく見えますが拒否されます：

* 配列の代わりに文字列値
* `agents` のディレクトリ配列
* `version` の欠落
* 推論されたパスへの依存
* マーケットプレイスの動作がローカルバリデーションと一致すると仮定すること
* **`"hooks": "./hooks/hooks.json"` の追加** - 慣習により自動読み込み、重複エラーを引き起こす

巧妙さを避け、明示的にしてください。

---

## 最小限の動作確認済み例

```json
{
  "version": "1.1.0",
  "agents": [
    "./agents/planner.md",
    "./agents/code-reviewer.md"
  ],
  "commands": ["./commands/"],
  "skills": ["./skills/"]
}
```

この構造は Claude プラグインバリデーターに対して検証済みです。

**重要:** `"hooks"` フィールドがないことに注意してください。`hooks/hooks.json` ファイルは慣習により自動的に読み込まれます。明示的に追加すると重複エラーが発生します。

---

## コントリビューターへの推奨事項

`plugin.json` に影響を与える変更を提出する前に：

1. agents には明示的なファイルパスを使用
2. すべてのコンポーネントフィールドが配列であることを確認
3. `version` を含める
4. 以下を実行：

```bash
claude plugin validate .claude-plugin/plugin.json
```

迷った場合は、便利さよりも冗長さを選んでください。

---

## このファイルが存在する理由

このリポジトリは広くフォークされ、リファレンス実装として使用されています。

ここにバリデーターの癖をドキュメント化することで：

* 繰り返しの問題を防止
* コントリビューターのフラストレーションを軽減
* エコシステムの進化に伴うプラグインの安定性を維持

バリデーターが変更された場合は、まずこのドキュメントを更新してください。
